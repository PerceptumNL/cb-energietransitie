<html>
  <head>
  <script src="jquery-1.7.2.min.js"></script>
  <script src="jquery.color.js"></script>
  <script>

function create_questions(targets, config) {
  var curr_concept = null;
  var done_concepts = [];
  var list_concepts = [];
  var results = [];
  var log = function(str) { console.log(str) };
  
  function next_question() {
    if (curr_concept == null) {
      $.each(targets, function(k,v) {
        $.each(v.concepts, function(_k,_v) {
          _v.correct_idx = k
          _v.incorrect = false;
          _v.correct = false;
          _v.attemps = [];
          list_concepts.push(_v);
        })
      });
    }
    if (list_concepts.length == 0) {
      $("#activity").hide();
      $("#results").show();
      var correct=0, incorrect=0;
      $.each(results, function(k, v) {
        if (v.correct) 
            correct += 1;
        else if (v.incorrect)
            incorrect += 1;
      });
      $("#correct").html(correct);
      $("#incorrect").html(incorrect);
      $.post('/activity', {config: config, results: results}, function() {
        log("Activity results sent");
      }).fail(function() { 
        log("Error sending activity results");
      });
      
      //alert("Activity finished");
      return;
    }
  
    curr_idx = Math.floor(Math.random()*(list_concepts.length))
    curr_concept = list_concepts[curr_idx];
  
    draw_question();
  
    //update lists
    list_concepts.splice(curr_idx,1);
    done_concepts.push(curr_concept);
  }
  
  function draw_question() {
    if (curr_concept.type == "text") {
      $("#concepts").html(curr_concept.text);
    } else if (curr_concept.type == "image") {
      $("#concepts").html("<img id='concept_img' src='"+curr_concept.image+"'/>");
      $("#concepts").append("<div>"+curr_concept.text+"</div>");
    }
  }

  function feedback_correct(answer_idx) {
    var $ele = $($("#targets").children()[answer_idx]);
    $ele.animate({
        backgroundColor: "green"
      },{
        duration: 100
    }).animate({
        backgroundColor: "gray"
      },{
        duration: 100,
        complete: function() {
          next_question();
        }
    });
  }

  function feedback_incorrect(answer_idx) {
    $("#targets").css("z-index", "0");
    var $ele = $($("#targets").children()[answer_idx]);
    $ele.css("z-index", 100)
    $ele.animate({
        backgroundColor: "red",
        left: "-=20px"
      },{
        duration: 50
    }).animate({
        left: "+=40px"
      },{
        duration: 100
    }).animate({
        backgroundColor: "gray",
        left: "-=20px"
      },{
        duration: 50 
    });
  }
  
  function check_answer(answer_idx) {
    curr_concept.attemps.push(answer_idx);
    if (curr_concept.correct_idx == answer_idx) {
      if (!curr_concept.incorrect) {
        curr_concept.correct = true;
      }
      log("Good! continue with next concept");
      feedback_correct(answer_idx);
      results.push(curr_concept);
    } else {
      curr_concept.incorrect = true;
      log("Wrong... Try again!");
      feedback_incorrect(answer_idx);
    }
  }

  var per = 95 / targets.length
  $.each(targets, function(k, v) {
    div = $("<div>").text(v.text).css("width", per + "%");
    $("#targets").append(div);
    div.click(function() { check_answer(k) });
    $("#targets").children().hover(
      function() {
        $(this).css({ 
            backgroundColor: 'grey',
            borderColor: 'yellow',
            color: 'yellow'
        });
      },
      function() {
        $(this).css({
            backgroundColor: 'white',
            borderColor: 'black',
            color: 'black'
        });
      }
    )
  });
  next_question();
}

window.onload = function() {
  var config = {
    activity_name: "Test"
  };
  var targets = [
    {
      type: "text",
      text: "YES",
      concepts: [
        { 
          type: "text",
          text: "Are you human?",
        },
        { 
          type: "image",
          text: "Is this a dog?",
          image: "/dog.jpg",
        },
      ]
    },
    {
      type: "text",
      text: "NO",
      concepts: [
        { 
          type: "text",
          text: "Are you a pet?",
        },
      ]
    }
  ]
  create_questions(targets, config);
}

  </script>
  <style>
#concept_img {
  height: 200px;
}
#concepts {
  height: 300px;
}
#targets {
  text-align: center;
}
#targets div {
  width: 100%;
  display: inline-block;
  text-align: center;
  border: 1px solid black;
  line-height: 50px;
  font-size: 30px;
  cursor: pointer;
  position: relative;
}
#targets div:hover {
  background-color: gray;
}
  </style>
  </head>

  <body>
    <div id="results" style="display:none">
        Correct: <span id="correct"></span><br />
        Incorrect: <span id="incorrect"></span>
    </div>
    <div id="activity">
      <div id="concepts"></div>
      <div id="targets"></div>
    </div>
  </body>
</html>
